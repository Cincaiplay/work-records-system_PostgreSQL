<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title><%= title %></title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="/css/styles.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
</head>

<body 
  class="bg-light"
  data-company-id="<%= user?.company_id ?? '' %>"
  data-can-see-rates="<%= (isAdmin || (permissions || []).includes('WORK_ENTRY_EDIT_RATES')) ? '1' : '0' %>">
  <%- include("partials/navbar", { active: "records" }); %>

  <div class="container py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4 pb-2 border-bottom">
      <div>
        <h1 class="fw-bold text-primary display-6">
          <i class="bi bi-list-ul me-2"></i> Work Entries Records
        </h1>
        <p class="text-muted small mb-0">
          View all saved work entries from the database.
        </p>
      </div>

      <div class="d-flex gap-2">
        <button class="btn btn-outline-danger rounded-pill" id="deleteSelectedBtn" disabled>
          <i class="bi bi-trash"></i> Delete Selected
        </button>
      </div>
    </div>

    <!-- Filters row -->
    <div class="row g-3 mb-3">
      <div class="d-flex gap-4 col-md-12">
        <div class="col-md-3">
          <label class="form-label">From Date</label>
          <input type="date" id="filterDateFrom" class="form-control" />
        </div>

        <div class="col-md-3">
          <label class="form-label">To Date</label>
          <input type="date" id="filterDateTo" class="form-control" />
        </div>
      </div>

      <div class="col-md-3">
        <label class="form-label small mb-1">Filter by Job No (1 / 2)</label>
        <input type="text" id="filterJobNo" class="form-control form-control-sm" placeholder="Job No1 or Job No2" />
      </div>

      <div class="col-md-3">
        <label class="form-label small mb-1">Filter by Worker</label>
        <input type="text" id="filterWorker" class="form-control form-control-sm" placeholder="Worker code / name" />
      </div>

      <div class="col-md-3">
        <label class="form-label small mb-1">Filter by Job (Code / Type)</label>
        <input type="text" id="filterJob" class="form-control form-control-sm" placeholder="Job code or type" />
      </div>

      <div class="col-md-3">
        <label class="form-label small mb-1">Filter by Note</label>
        <input type="text" id="filterNote" class="form-control form-control-sm" placeholder="Discount / remark..." />
      </div>
    </div>

    <!-- Sort + export row -->
    <div class="row mb-4 align-items-center">
      <div class="col-lg-8 col-md-12"></div>

      <div class="col-lg-4 col-md-12 mt-3 mt-lg-0 text-md-start text-lg-end">
        <div class="d-inline-block me-2">
          <button class="btn btn-outline-secondary rounded-pill dropdown-toggle"
                  type="button" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="bi bi-sort-alpha-down"></i> Sort
          </button>

          <ul class="dropdown-menu">
            <li><a class="dropdown-item sort-option" data-sort="date_asc" href="#">Date ↑ (Oldest)</a></li>
            <li><a class="dropdown-item sort-option" data-sort="date_desc" href="#">Date ↓ (Newest)</a></li>
            <li><hr class="dropdown-divider" /></li>
            <li><a class="dropdown-item sort-option" data-sort="job_asc" href="#">Job ↑</a></li>
            <li><a class="dropdown-item sort-option" data-sort="job_desc" href="#">Job ↓</a></li>
            <li><hr class="dropdown-divider" /></li>
            <li><a class="dropdown-item sort-option" data-sort="wage_asc" href="#">Wage Total ↑</a></li>
            <li><a class="dropdown-item sort-option" data-sort="wage_desc" href="#">Wage Total ↓</a></li>
            <li><a class="dropdown-item sort-option" data-sort="customer_asc" href="#">Customer Total ↑</a></li>
            <li><a class="dropdown-item sort-option" data-sort="customer_desc" href="#">Customer Total ↓</a></li>
          </ul>
        </div>

        <button class="btn btn-outline-secondary rounded-pill" disabled title="Later">
          <i class="bi bi-download"></i> Export
        </button>
      </div>
    </div>

    <!-- Records table -->
    <div class="card shadow-sm border-0 rounded-4">
      <div class="card-body p-0">
        <div class="table-responsive">

          <!-- Top controls -->
          <div class="d-flex justify-content-between align-items-center mb-2 px-2 pt-2">
            <div class="d-flex align-items-center gap-2">
              <small class="text-muted" id="recordsCountTop"></small>

              <div class="d-flex align-items-center gap-2">
                <small class="text-muted">Rows:</small>
                <select id="recordsPageSize" class="form-select form-select-sm" style="width: 90px;">
                  <option value="10" selected>10</option>
                  <option value="20">20</option>
                  <option value="50">50</option>
                  <option value="100">100</option>
                </select>
              </div>
            </div>

            <nav>
              <ul class="pagination pagination-sm mb-0" id="recordsPaginationTop"></ul>
            </nav>
          </div>

          <table class="table table-hover mb-0" id="recordsTable">
            <thead class="table-primary small text-uppercase">
              <tr>
                <th scope="col" class="text-center" style="width: 40px;">
                  <input type="checkbox" id="selectAllRecords" />
                </th>
                <th scope="col">#</th>
                <th scope="col">Date</th>
                <th scope="col">Job No1</th>
                <th scope="col">Job No2</th>
                <th scope="col">Worker</th>
                <th scope="col">Job</th>
                <th scope="col" class="text-end">Hours</th>
                <th scope="col" class="text-end">Fees Collected</th>

                <th scope="col" class="text-end" data-col="cust_rate">Cust_Rate</th>
                <th scope="col" class="text-end" data-col="cust_total">Cust_Total</th>

                <th scope="col" class="text-end" data-col="wage_rate">Wage Rate</th>
                <th scope="col" class="text-end" data-col="wage_total">Wage Total</th>

                <th scope="col">Note</th>
                <th scope="col" class="text-end">Actions</th>
              </tr>
            </thead>

            <tbody id="recordsBody">
              <tr>
                <td id="recordsLoadingCell" colspan="14" class="text-center text-muted py-4">
                  <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                  Loading records...
                </td>
              </tr>
            </tbody>

            <tfoot>
              <tr class="fw-bold" id="recordsFeesTotalRow">
                <td id="recordsFeesLabelCell" colspan="14" class="text-end text-dark">
                  GRAND TOTAL (ACTUAL COLLECTED):
                </td>
                <td class="text-dark" id="recordsGrandTotalFees">0.00</td>
              </tr>

              <tr class="fw-bold" id="recordsCustomerTotalRow">
                <td id="recordsCustomerLabelCell" colspan="14" class="text-end text-success">
                  GRAND TOTAL (CUSTOMER):
                </td>
                <td class="text-success" id="recordsGrandTotalCustomer">0.00</td>
              </tr>

              <tr class="fw-bold" id="recordsWageTotalRow">
                <td id="recordsWageLabelCell" colspan="14" class="text-end text-primary">
                  TOTAL WAGES:
                </td>
                <td class="text-primary" id="recordsGrandTotalWage">0.00</td>
              </tr>
            </tfoot>


          </table>

          <!-- Bottom controls -->
          <div class="d-flex justify-content-between align-items-center mt-2 px-2 pb-2">
            <small class="text-muted" id="recordsCountBottom"></small>
            <nav>
              <ul class="pagination pagination-sm mb-0" id="recordsPaginationBottom"></ul>
            </nav>
          </div>

        </div>
      </div>
    </div>

  </div>

  <div class="modal fade" id="editEntryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content rounded-4">
        <div class="modal-header">
          <h5 class="modal-title">Edit Work Entry</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <input type="hidden" id="editEntryId" />

          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label">Date</label>
              <input type="date" id="editWorkDate" class="form-control" />
            </div>

            <div class="col-md-4">
              <label class="form-label">Job No1</label>
              <input type="text" id="editJobNo1" class="form-control" />
            </div>

            <div class="col-md-4">
              <label class="form-label">Job No2</label>
              <input type="text" id="editJobNo2" class="form-control" />
            </div>

            <div class="col-md-4">
              <label class="form-label">Worker</label>
              <select id="editWorkerId" class="form-select"></select>
            </div>


            <div class="col-md-4">
              <label class="form-label">Hours</label>
              <input type="number" id="editAmount" class="form-control" min="0" step="0.5" />
            </div>

            <div class="col-md-4">
              <label class="form-label">Pay Type</label>
              <select id="editIsBank" class="form-select">
                <option value="0">Cash</option>
                <option value="1">Bank</option>
              </select>
            </div>

            <div class="col-md-4">
              <label class="form-label">Job</label>
              <select id="editJobCode" class="form-select"></select>
            </div>

            

            <div class="col-12">
              <label class="form-label">Note</label>
              <input type="text" id="editNote" class="form-control" />
            </div>

          </div>


          <div class="row g-3 mt-1" id="ratesFields">
            <div class="my-2 border-top"></div>

            <div class="col-md-12">
              <label class="form-label">Wage Tier</label>
              <select id="editWageTierId" class="form-select"></select>
            </div>

              <div class="col-md-6">
                <label class="form-label">Customer Rate</label>
                <input type="number" step="0.01" class="form-control" id="editCustomerRate">
              </div>

              <div class="col-md-6">
                <label class="form-label">Wage Rate</label>
                <input type="number" step="0.01" class="form-control" id="editWageRate">
              </div>

              <div class="col-md-6">
                <label class="form-label">Customer Total</label>
                <input type="text" class="form-control" id="editCustomerTotal" disabled>
              </div>

              <div class="col-md-6">
                <label class="form-label">Wage Total</label>
                <input type="text" class="form-control" id="editWageTotal" disabled>
              </div>
            </div>
        </div>

        <div class="modal-footer">
          <div class="me-auto small text-muted" id="editEntryHint"></div>
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="saveEditEntryBtn">
            Save Changes
          </button>
        </div>
      </div>
    </div>
  </div>


  <script type="application/json" id="pagePerms">
    <%- JSON.stringify({
      canEditRates: (isAdmin || (permissions || []).includes("WORK_ENTRY_EDIT_RATES")),
      canEditEntry: (isAdmin || (permissions || []).includes("WORK_ENTRY_EDIT")),
      canDeleteEntry: (isAdmin || (permissions || []).includes("WORK_ENTRY_DELETE")),
    }) %>
  </script>

  <script>
    const perms = JSON.parse(document.getElementById("pagePerms").textContent);
    window.CAN_EDIT_RATES = perms.canEditRates;
    window.CAN_EDIT_ENTRY = perms.canEditEntry;
    window.CAN_DELETE_ENTRY = perms.canDeleteEntry;
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/js/company-switcher.js"></script>
  <script src="/js/records.js"></script>
</body>
</html>
