<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title><%= title || "Dashboard" %></title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet" />

  <!-- Handsontable CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@14.3.0/dist/handsontable.full.min.css" />

  <!-- Custom CSS -->
  <link rel="stylesheet" href="/css/styles.css" />

</head>

<body
  class="bg-light"
  data-company-id="<%= user?.company_id ?? '' %>"
  data-is-admin="<%= isAdmin ? '1' : '0' %>"
  data-can-see-rates="<%= canSeeRates ? '1' : '0' %>">


  <!-- Navbar -->
  <%- include("partials/navbar", { active: "dashboard" }); %>

  <div class="container py-4">
    <!-- Title -->
    <header class="text-center mb-4">
      <h1 class="fw-bold text-primary display-5 mb-1" id="companyTitle">
        
      </h1>
      <p class="text-muted small">
        Daily records of jobs done
      </p>
    </header>

    <!-- Record New Work Entry card -->
    <section class="card shadow-lg border-0 rounded-4 mb-4">
      <div class="card-body p-4">

        <!-- Header with mode switch -->
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h2 class="h4 fw-bold mb-0">Record New Work Entry</h2>

          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="batchModeSwitch" />
            <label class="form-check-label small fw-medium" for="batchModeSwitch">
              Excel-style Batch Entry
            </label>
          </div>
        </div>

        <!-- ========== MODE 1: Single-entry form ========== -->
        <div id="singleEntryMode">
          <form>
            <div class="row g-3 mb-3">
              <!-- Job No -->
               <!-- Date -->
              <div class="col-6">
                <label for="workDate" class="form-label fw-medium">Date</label>
                <input type="date" id="workDate" class="form-control" />
              </div>
              <div class="col-6"></div>
              
              <div class="col-6">
                <label class="form-label fw-medium">Job No1</label>
                <input type="text" id="jobNo1" class="form-control" placeholder="Enter Job No1" />
              </div>

              <div class="col-6">
                <label class="form-label fw-medium">Job No2</label>
                <input type="text" id="jobNo2" class="form-control" placeholder="Enter Job No2" />
              </div>

              <!-- Worker Name -->
              <div class="col-6">
                <label for="workerSelect" class="form-label fw-medium">Worker ID</label>
                <select id="workerSelect" class="form-select">
                  <option value="" disabled selected>Select worker</option>
                </select>
              </div>

              <!-- Job Code & Type -->
              <div class="col-6">
                <label for="jobCode" class="form-label fw-medium">Job Code &amp; Type</label>
                <select id="jobCode" class="form-select">
                  <option value="" disabled selected>Select job</option>
                </select>
              </div>

              

              <!-- Hours -->
              <div class="col-6">
                <label for="amount" class="form-label fw-medium">Job Hour</label>
                <input type="number" id="amount" class="form-control" placeholder="Enter amount" min="0" step="0.5" />
              </div>

                <!-- Fees Collected (optional) -->
                <div class="col-6">
                  <label for="feesCollected" class="form-label fw-medium">Fees Collected (actual)</label>
                  <input
                    type="number"
                    id="feesCollected"
                    class="form-control"
                    placeholder="0"
                    min="0"
                    step="0.5"
                  />
                  <div class="form-text">
                    If customer paid more than fee (tips), record the actual amount here.
                  </div>
                </div>
                
                <!-- Note -->
                <div class="col-6">
                <label for="note" class="form-label fw-medium">Note (optional)</label>
                <input
                    type="text"
                    id="note"
                    class="form-control"
                    placeholder="e.g. extra request / remark"
                />
                </div>

                <!-- ‚úÖ Payment method: Bank transfer toggle (clickable card) -->
                <div class="col-12 mt-2">
                <label
                    for="isBank"
                    id="isBankCard"
                    class="d-flex align-items-center gap-3 p-3 rounded-3 border bank-card"
                    style="cursor:pointer; user-select:none;"
                >
                    <input
                    class="form-check-input m-0"
                    type="checkbox"
                    id="isBank"
                    style="transform: scale(1.2);"
                    />

                    <div class="d-flex align-items-center gap-2">
                    <i class="bi bi-wallet2 fs-5 text-primary"></i>
                    <span class="fw-bold">Bank Transfer Payment Method</span>
                    </div>

                    <span class="text-muted small ms-2">
                    (Unticked = Cash Payout)
                    </span>
                </label>
                </div>


              <!-- üîÄ Switch: show custom overrides -->
              <div class="col-12 mt-2" id="customOverrideSwitchRow">
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="useCustomOverride" />
                  <label class="form-check-label fw-medium" for="useCustomOverride">
                    Use Custom Overrides
                  </label>
                </div>
              </div>

              <!-- Custom overrides (hidden unless switch ON) -->
              <div class="col-12" id="customOverrideOptions" style="display: none;">
                <div class="row g-2 align-items-end mt-1">
                  <div class="col-md-6">
                    <label class="form-label small">Customer Custom Price (per hour)</label>
                    <input type="number" step="0.01" id="customCustomerRate" class="form-control"
                      placeholder="Leave blank = normal price" />
                  </div>

                  <div class="col-md-6">
                    <label class="form-label small">Worker Custom Wage (per hour)</label>
                    <input type="number" step="0.01" id="customWageRate" class="form-control"
                      placeholder="Leave blank = base wage" />
                  </div>
                </div>
              </div>

            </div>

            <button type="button" class="btn btn-primary btn-lg w-100" onclick="addEntryToTable()">
              Record New Entry
            </button>
          </form>
        </div>

        <!-- ========== MODE 2: Handsontable Excel-style batch ========== -->
        <div id="batchEntryMode" style="display: none;">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <p class="text-muted small mb-0">
              Enter multiple rows in the grid below, then click
              <strong>"Add Rows to Pending Table"</strong>.
            </p>

            <div class="d-flex align-items-center gap-2">
              <div class="input-group input-group-sm" style="width: 180px;">
                <span class="input-group-text">Rows</span>
                <input type="number" class="form-control" id="batchRowCount" min="1" max="500" value="10" />
                <button class="btn btn-outline-secondary" type="button" onclick="applyBatchRowCount()">
                  Set
                </button>
              </div>
            </div>
          </div>

          <div class="alert alert-light border rounded-3 py-2 small mb-2">
            <div class="d-flex align-items-center gap-2">
              <i class="bi bi-info-circle text-primary"></i>
              <div>
                Batch mode defaults to <b>Cash</b>. If it is a bank transfer, fill the ‚ÄúIs Bank‚Äù column with <code>y</code>.
              </div>
            </div>
          </div>

          <div id="hotBatch" style="width: 100%; min-height: 300px;"></div>

          <div class="d-flex justify-content-end mt-3">
            <button type="button" class="btn btn-primary" onclick="addBatchRowsToPending()">
              Add Rows to Pending Table
            </button>
          </div>
        </div>

      </div>
    </section>

    <!-- Work Entries table card -->
    <section class="card shadow-lg border-0 rounded-4">
      <div class="card-body p-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div>
            <h2 class="h4 fw-bold mb-1">Work Entries</h2>
          </div>
          <button type="button" class="btn btn-success" id="importExcelBtn">
            <i class="bi bi-file-earmark-spreadsheet"></i>
            Import Excel (Bulk)
          </button>
        </div>

        <div class="table-responsive rounded-3 border">
          <table class="table table-hover align-middle mb-0">
            <thead class="table-primary small text-uppercase">
              <tr>
                <th scope="col">#</th>
                <th scope="col">Date</th>
                <th scope="col">Job No1</th>
                <th scope="col">Job No2</th>
                <th scope="col">Worker</th>
                <th scope="col">Job Code &amp; Type</th>
                <th scope="col">Hours</th>
                <th scope="col">Pay Type</th>
                <th scope="col">Fees Collected</th>

                <th scope="col" data-col="cust_rate">Cust_Rate</th>
                <th scope="col" data-col="cust_total">Cust_Total</th>
                <th scope="col" data-col="wage_rate">Wage Rate</th>
                <th scope="col" data-col="wage_total">Wage Total</th>


                <th scope="col">Note</th>
                <th scope="col">Actions</th>
              </tr>
            </thead>
            
            <div id="saveStatus" class="small text-muted mb-2" style="display:none;">
                Saving to database...
            </div>


            <tbody id="workEntriesBody">
              <tr class="text-muted">
                <td colspan="15" class="text-center fst-italic py-3">
                  No work entries recorded yet.
                </td>
              </tr>
            </tbody>

            <tfoot>
              <tr class="fw-bold">
                <td id="grandTotalLabelCell" colspan="13" class="text-end text-primary">
                  GRAND TOTAL:
                </td>
                <td class="text-primary" id="grandCustomerTotalCell">0.00</td>
                <td class="text-end text-primary" hidden>Wages Total:</td>
                <td class="text-primary" id="grandTotalCell" hidden>0.00</td>
                <td></td>
              </tr>
            </tfoot>
          </table>
        </div>

        <!-- Confirm button below table -->
        <div class="mt-3 text-end">
          <button
            type="button"
            id="confirmSaveBtn"
            class="btn btn-success"
            onclick="confirmEntries()"
            >
            Confirm &amp; Save
            </button>

        </div>
      </div>
    </section>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Handsontable JS -->
  <script src="https://cdn.jsdelivr.net/npm/handsontable@14.3.0/dist/handsontable.full.min.js"></script>

  <!-- Global company switcher -->
  <script src="/js/company-switcher.js"></script>

  <!-- Dashboard logic -->
  <script src="/js/dashboard.js"></script>
</body>

</html>
