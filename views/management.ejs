<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title><%= title || "Management" %></title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet" />
</head>

<body class="bg-light">
  <%- include("partials/navbar", { active: (typeof active !== "undefined" ? active : null) }); %>

  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <header class="mb-4">
        <h1 class="fw-bold text-primary">Management</h1>
        <p class="text-muted small mb-0">Admin tools</p>
      </header>
    </div>

    <% const usersSafe = Array.isArray(users) ? users : []; %>
    <% const rolesSafe = Array.isArray(roles) ? roles : []; %>
    <% const companiesSafe = Array.isArray(companies) ? companies : []; %>
    <% const permsSafe = Array.isArray(permissions) ? permissions : []; %>
    <% const rolePermsSafe = Array.isArray(rolePerms) ? rolePerms : []; %>
    <% const permsAllSafe = Array.isArray(permissionsAll) ? permissionsAll : []; %>

    <%
      const companyMap = new Map(
        companiesSafe.map(c => [
          Number(c.id),
          `${c.short_code} - ${c.name}`
        ])
      );

      function roleHasPerm(roleId, permId) {
        return rolePermsSafe.some(rp =>
          Number(rp.role_id) === Number(roleId) &&
          Number(rp.permission_id) === Number(permId)
        );
      }
    %>

    <% if (typeof error === "string" && error) { %>
      <div class="alert alert-danger"><%= error %></div>
    <% } %>

    <% if (typeof success === "string" && success) { %>
      <div class="alert alert-success"><%= success %></div>
    <% } %>

    <div class="row g-4">
      <!-- LEFT: tabs -->
      <div class="col-12 col-lg-3">
        <div class="card border-0 shadow-sm rounded-4 sticky-top" style="top: 2rem;">
            <div class="card-body p-3">
            <div class="nav flex-column nav-pills gap-2"
                id="mgmtTabs"
                role="tablist"
                aria-orientation="vertical">

                <button class="nav-link text-start w-100 <%= (activeTab || 'users') === 'users' ? 'active' : '' %>"
                        id="tab-users"
                        data-bs-toggle="pill"
                        data-bs-target="#pane-users"
                        type="button"
                        role="tab"
                        aria-controls="pane-users"
                        aria-selected="<%= (activeTab || 'users') === 'users' ? 'true' : 'false' %>">
                <i class="bi bi-people me-2"></i> Users
                </button>

                <button class="nav-link text-start w-100 <%= activeTab === 'roles' ? 'active' : '' %>"
                        id="tab-roles"
                        data-bs-toggle="pill"
                        data-bs-target="#pane-roles"
                        type="button"
                        role="tab"
                        aria-controls="pane-roles"
                        aria-selected="<%= activeTab === 'roles' ? 'true' : 'false' %>">
                <i class="bi bi-shield-lock me-2"></i> Roles
                </button>

                <button class="nav-link text-start w-100 <%= activeTab === 'perms' ? 'active' : '' %>"
                        id="tab-perms"
                        data-bs-toggle="pill"
                        data-bs-target="#pane-perms"
                        type="button"
                        role="tab"
                        aria-controls="pane-perms"
                        aria-selected="<%= activeTab === 'perms' ? 'true' : 'false' %>">
                <i class="bi bi-key me-2"></i> Permissions
                </button>

                <button class="nav-link text-start <%= activeTab === 'wage_tiers' ? 'active' : '' %>"
                        id="tab-wage-tiers"
                        data-bs-toggle="pill"
                        data-bs-target="#pane-wage-tiers"
                        type="button"
                        role="tab"
                        aria-controls="pane-wage-tiers"
                        aria-selected="<%= activeTab === 'wage_tiers' ? 'true' : 'false' %>">
                  <i class="bi bi-layers me-2"></i> Wage Tiers
                </button> 


                <div class="my-2 border-top"></div>

                <button class="nav-link text-start w-100 <%= activeTab === 'audit' ? 'active' : '' %>"
                        id="tab-audit"
                        data-bs-toggle="pill"
                        data-bs-target="#pane-audit"
                        type="button"
                        role="tab"
                        aria-controls="pane-audit"
                        aria-selected="<%= activeTab === 'audit' ? 'true' : 'false' %>">
                <i class="bi bi-journal-text me-2"></i> Audit Logs
                </button>

            </div>
            </div>
        </div>
        </div>


      <!-- RIGHT: content -->
      <div class="col-12 col-lg-9">
        <div class="tab-content" id="mgmtTabsContent">

            <%- include("partials/management/users-pane", {
                activeTab,
                usersSafe,
                companiesSafe,
                companyMap,
                rolesSafe
            }) %>

            <%- include("partials/management/roles-pane", {
                activeTab,
                rolesSafe,
                companiesSafe,
                companyMap,
                permsSafe,
                rolePermsSafe,
                roleHasPerm,
                permsAllSafe
            }) %>

            <%- include("partials/management/perms-pane", {
                activeTab,
                permsSafe,
                permTotal,
                permPage,
                permPageSize,
                permTotalPages
            }) %>

            <%- include("partials/management/wage-tiers-pane", {
              activeTab,
              wageTiers,
              companiesSafe,
              companyMap
            }) %>

            <%- include("partials/management/audit-pane", { activeTab }) %>


        </div>
      </div>
    </div>
  </div>


  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/js/management.js"></script>
  <script src="/js/role-perm-search.js"></script>
  <script src="/js/company-switcher.js"></script>
</body>
</html>
